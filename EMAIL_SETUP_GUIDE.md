# üìß Email Configuration Guide for AluOptimize PDF Reports

## Overview

This guide will help you configure Gmail SMTP for sending PDF reports automatically.

---

## üîß Step 1: Gmail App Password Setup

### Why App Password?

Google requires App Passwords for applications accessing Gmail via SMTP when 2-Step Verification is enabled. Regular passwords won't work.

### Steps to Generate App Password:

1. **Enable 2-Step Verification**
   - Go to: https://myaccount.google.com/security
   - Find "2-Step Verification"
   - Click "Get Started" and follow the prompts
   - Verify your phone number

2. **Generate App Password**
   - Go to: https://myaccount.google.com/apppasswords
   - Or: Google Account ‚Üí Security ‚Üí 2-Step Verification ‚Üí App passwords
   - Select app: "Mail"
   - Select device: "Other (Custom name)"
   - Enter name: "AluOptimize"
   - Click "Generate"

3. **Copy the 16-Character Password**
   - Google will show a 16-character password like: `abcd efgh ijkl mnop`
   - **Copy this immediately** - you won't see it again
   - Remove spaces: `abcdefghijklmnop`

---

## üîß Step 2: Django Settings Configuration

### Option 1: Using Environment Variables (Recommended)

Create or update `.env` file in project root:

```bash
# Email Configuration
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=abcdefghijklmnop
```

Then in `backend/config/settings.py`:

```python
import environ

env = environ.Env()
environ.Env.read_env()

# Email Configuration
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = env('EMAIL_HOST', default='smtp.gmail.com')
EMAIL_PORT = env.int('EMAIL_PORT', default=587)
EMAIL_USE_TLS = env.bool('EMAIL_USE_TLS', default=True)
EMAIL_HOST_USER = env('EMAIL_HOST_USER', default='')
EMAIL_HOST_PASSWORD = env('EMAIL_HOST_PASSWORD', default='')
```

### Option 2: Direct Configuration (Not Recommended for Production)

Add to `backend/config/settings.py`:

```python
# Email Configuration
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.gmail.com'
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = 'your-email@gmail.com'
EMAIL_HOST_PASSWORD = 'abcdefghijklmnop'  # Your 16-char app password
```

‚ö†Ô∏è **Security Warning:** Never commit passwords to version control!

---

## üîß Step 3: Test Email Configuration

Create a test script `test_email.py`:

```python
#!/usr/bin/env python
import os
import sys
import django

sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.config.settings')
django.setup()

from django.core.mail import send_mail
from django.conf import settings

def test_email():
    try:
        print(f"Testing email from: {settings.EMAIL_HOST_USER}")
        print(f"SMTP Server: {settings.EMAIL_HOST}:{settings.EMAIL_PORT}")
        
        send_mail(
            subject='AluOptimize Email Test',
            message='This is a test email from AluOptimize. If you receive this, email configuration is working!',
            from_email=settings.EMAIL_HOST_USER,
            recipient_list=['your-test-email@example.com'],
            fail_silently=False,
        )
        
        print("‚úÖ Email sent successfully!")
        return True
        
    except Exception as e:
        print(f"‚ùå Error sending email: {str(e)}")
        return False

if __name__ == '__main__':
    test_email()
```

Run the test:
```bash
source virtual/bin/activate
python test_email.py
```

---

## üîß Step 4: Verify PDF Report Email

### Using Admin Dashboard:

1. Login as admin
2. Go to Admin Dashboard ‚Üí Reports tab
3. Select "Users Report"
4. Check "Email report to user"
5. Select a user (with valid email)
6. Click "Generate & Email PDF"

### Expected Result:

```
‚úÖ Report PDF generated and emailed to user@example.com!
```

### Check User's Inbox:

**Subject:** AluOptimize Users Report

**Body:**
```
Dear Username,

Your Users report has been generated by AdminName.

This report contains detailed information about your aluminum production optimization data.

Please find the PDF report attached to this email.

If you have any questions about this report, please contact your administrator.

Best regards,
AluOptimize Team

---
This is an automated email. Please do not reply to this message.
```

**Attachment:** `aluoptimize_users_report.pdf`

---

## üîß Alternative SMTP Providers

### Using Other Email Services:

#### Outlook/Office 365:
```python
EMAIL_HOST = 'smtp-mail.outlook.com'
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = 'your-email@outlook.com'
EMAIL_HOST_PASSWORD = 'your-password'
```

#### Yahoo Mail:
```python
EMAIL_HOST = 'smtp.mail.yahoo.com'
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = 'your-email@yahoo.com'
EMAIL_HOST_PASSWORD = 'your-app-password'
```

#### Custom SMTP Server:
```python
EMAIL_HOST = 'smtp.yourdomain.com'
EMAIL_PORT = 587  # or 465 for SSL
EMAIL_USE_TLS = True  # or EMAIL_USE_SSL = True
EMAIL_HOST_USER = 'noreply@yourdomain.com'
EMAIL_HOST_PASSWORD = 'your-password'
```

---

## üêõ Troubleshooting

### Error: "SMTPAuthenticationError"

**Cause:** Invalid credentials or app password not generated

**Solution:**
1. Verify EMAIL_HOST_USER is correct
2. Regenerate Gmail App Password
3. Ensure no spaces in app password
4. Check 2-Step Verification is enabled

### Error: "SMTPServerDisconnected"

**Cause:** Wrong SMTP server or port

**Solution:**
1. Verify EMAIL_HOST = 'smtp.gmail.com'
2. Verify EMAIL_PORT = 587
3. Ensure EMAIL_USE_TLS = True

### Error: "Connection refused"

**Cause:** Firewall blocking SMTP port

**Solution:**
1. Check firewall allows port 587
2. Try port 465 with EMAIL_USE_SSL = True
3. Check network/proxy settings

### Error: "Email not received"

**Possible Causes:**
1. Email in spam folder
2. Invalid recipient email
3. Gmail daily sending limit reached (500 emails/day)

**Solution:**
1. Check spam/junk folder
2. Verify recipient email is correct
3. Wait 24 hours if limit reached

---

## üìä Email Sending Limits

### Gmail:
- **Free accounts:** 500 emails per day
- **Google Workspace:** 2,000 emails per day
- **Per message:** Max 100 recipients

### Best Practices:
- Use a dedicated email account for system notifications
- Monitor sending volume
- Implement rate limiting if sending many reports
- Consider using a transactional email service (SendGrid, Mailgun) for high volume

---

## üîí Security Best Practices

1. **Never commit credentials to Git**
   ```bash
   # Add to .gitignore
   .env
   *.env
   ```

2. **Use environment variables**
   - Store sensitive data in `.env`
   - Use `django-environ` or `python-decouple`

3. **Rotate passwords regularly**
   - Change app passwords every 90 days
   - Revoke unused app passwords

4. **Monitor email logs**
   - Check Django logs for email failures
   - Monitor for suspicious activity

5. **Use dedicated email account**
   - Don't use personal email
   - Create `noreply@yourdomain.com` or similar

---

## ‚úÖ Quick Setup Checklist

- [ ] Enable 2-Step Verification on Gmail
- [ ] Generate Gmail App Password
- [ ] Add email settings to `.env` or `settings.py`
- [ ] Add `.env` to `.gitignore`
- [ ] Test email configuration with test script
- [ ] Generate test PDF report via admin dashboard
- [ ] Verify email received with PDF attachment
- [ ] Check PDF opens correctly with branding
- [ ] Document email account credentials securely

---

## üìû Support

If you encounter issues:

1. Check Django logs: `tail -f logs/django.log`
2. Check email backend logs in console
3. Verify all settings are correct
4. Test with simple `send_mail()` first
5. Check Gmail account security settings

---

**Last Updated:** November 6, 2025  
**Status:** ‚úÖ Ready for Production  
**Tested with:** Gmail SMTP, Django 5.2.7
